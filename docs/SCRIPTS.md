# Скрипты и компоненты (**src/js**)

## Общая информация

Все JS-файлы, находящиеся непосредственно в каталоге **`src/js`**, при разработке (и сборке) проекта будут транспайлиться в JS-файлы с аналогичными именами и переноситься в **`/public/js/`** (**`/build/js/`**).

Все компоненты интерфейса разрабатываются с помощью реактивного UI-фреймворка **[Svelte](https://svelte.dev/)**. Каждый из них в свою очередь может содержать подкомпоненты.

## Структура

### Основа (**src/js**)

- **scripts.js** - основной скрипт fronend-приложения. Подключается внутри HTML-страницы во время разработки (и сборки). Монтирует и запускает frontend-приложение, после того как инициализируется JS-клиент для Qlik.
- **apiTests.js** - вспомогательный скрипт для разработки. Подключается внутри HTML-страницы, если приложение работает в режиме тестов API. После инициализации JS-клиента для Qlik, он делает серию запросов и выводит их результаты в консоль браузера.
- **proxy.js** - скрипт прокси для запросов в Qlink. Подключается внутри HTML-страницы при сборке. Инициализирует JS-клиент для Qlik и фасилитирует обмен запросами и ответами между ним и frontend-приложением.
- **proxyDev.js** - скрипт прокси для mock-запросов в Qlik. Подключается внутри HTML-страницы во время разработки. Инициализирует псевдо-клиент для Qlik фасилитирует обмен запросами и mock-ответами между frontend-приложением и хранилищем mock-данных.

### Клиент (**src/js/client**)

- Инициализирует JS-клиент для Qlik (**js/qlik**) во время загрузки приложения
- Интерпретирует запросы из fronend-приложения на основе данных из событий `datarequest`
- Делает (последовательные) запросы в Qlik, обрабатывает и собирает ответы в один объект
- Передает данные полученные из Qlik в прокси для формирования ответа для frontend-приложения

### Компоненты (**src/js/components**)

#### App

Внешняя оболочка приложения. Наcтраивает роутинг и инициализирует общий контекст всего приложения.

#### core

Фундаментальные нестандартные компоненты интерфейса

- **dropdown** – мета-компонент. Контроллер для выпадающего контента (используется для выпадающих меню и прочих опций)
- **input** – текстовое поле
- **internationalization** – компонент интернационализации
- **navLink** – навигационная ссылка
- **overlay** – оверлей
- **pick** – одиночная опция
- **select** – выпадающий список
- **stepper** – множественные опции

#### page

Страницы

- **AuthPage** - страница авторизации (не используется)
- **DashboardPage** - страница дашборда
- **DefaultPage** - страница по умолчанию. Если текущий маршрут не ведет ни на одну из остальных страниц, то пользователь попадает на страницу по умолчанию
- **ErrorPage** - страница ошибки
- **InitializationPage** - страница инициализации приложения
- **LogoutPage** - страница выхода (не используется)

#### Aside

Левое боковое меню навигации по дашбордам и показателям.

#### Auth (не используется)

Форма авторизации

#### BarChart

График-гистограмма

#### ColumnOptions

Опции правой колонки дашборда

#### Comparisons

Таблица сравнений

#### Comparison

Сравнение по показателю (ряд в таблице сравнений)

#### ComparisonIndicators

Список сравнений по показателю

#### Confirmation

Попап с запросом подтверждения действия пользователя

#### ConsolidatedGraph

Общий график для сопоставления нескольких показателей (средний чек и т.п.)

#### ControlledSelect

Выпадающий список с фильтром и подтверждением выбора

#### Dashboard

Мета-компонент. Отриcовывает текущее состояние дашборда в зависимости от маршрута.

#### Datepicker

Выбор даты (календарь)

#### Defs

Общий набор определений для SVG-компонентов интерфейса (заливка для линий графиков и факторов)

#### Deviation

Отклонение

#### Drawer

Мета-компонент. Контент выезжающий из-за границ экрана (используется для боковых меню и т.п.)

#### DropdownDrawer

Мета-компонент. Выпадающий контент (используется для выпадающих меню и прочих опций)

#### Export

Страница экспорта

#### ExportIndicators

Индикаторы для экспорта

#### ExportIndicator

Индикатор для экспорта (компонент в списке индикаторов выбранных для экспорта)

#### ExportSlices

Срезы для экспорта

#### ExportSlice

Срез для экспорта (компонент в списке срезов выбранных для экспорта)

#### Factors

Таблица факторов

#### Factor

Фактор (ряд в таблице факторов)

#### FactorIndicators

Индикатор в таблице факторов (пунктирная линия)

#### FactorsTotal

Верхние суммарные значения в таблице факторов

#### FactorsComparison

Нижние суммарные значения в таблице факторов

#### Filter

Фильтр дашборда

#### GraphHeader

Хедер колонки графиков (правая часть хедера со шкалой)

#### GraphOptions

Опции графика (левая часть хедера графиков)

#### GraphScale

Шкала колонки графиков (с месяцами, кварталами и т.п.)

#### GraphStickers

Стикеры на шкале колонки графиков (с месяцами, годами и пр.)

#### Header

Хедер приложения

#### Indicators

Список показателей с фильтром (в боковых меню)

#### KPI

Показатель (ряд в таблице показателей)

#### LineGraph

Линейный график

#### List

Мета-компонент. Фильтрующийся список сущностей (используется для опций фильтруемых выпадающих меню и т.п.)

#### Loader

Индикатор загрузки

#### Menu

Меню

#### Overview

Страница обозрения дашборда (таблица показателей)

#### Picks

Набор опций (используется в фильтре)

#### Scroll

Мета-компонент. Контроллер вертикального скролла

#### Slices

Страница срезов (таблица срезов)

#### Slice

Срез (ряд в таблице срезов)

#### TableHeader

Хедер таблицы

#### Templates

Список шаблонов (закладок)

#### Template

Шаблон (закладка) (элемент в списке закладок)

#### Title

Мета-компонент. Контроллер заголовка страницы (на вкладке браузера)

#### Tooltip

Мета-компонент. Тултип (используется для отрисовки контента в тултипах)

### Конфигурации (**src/js/configs**)

Набор JSON-файлов с конфигурациями различных аспектов приложения

- **app.json** – базовая конфигурация frontend-приложения
- **client.json** – базовая конфигурация клиента для Qlik (токен, параметры подключения и т.п.)

#### dashboards/financial

Конфигурация финансового дашборда

- **column.json** – опции для значений правой колонки таблицы в финансовом дашборде
- **filter.json** – конфигурация фильтра финансового дашборда
- **indicators.json** – конфигурация показателей финансового дашборда (название, порядок и т.п.)

#### dashboards/operational

Конфигурация операционного дашборда

- **column.json** – опции для значений правой колонки таблицы в операционном дашборде
- **filter.json** – конфигурация фильтра операционного дашборда
- **indicators.json** – конфигурация показателей операционного дашборда (название, порядок и т.п.)

#### dictionaries

Словари для интернационализации

- **english.json** – английский словарь

#### requests

Конфигурации запросов в Qlik

##### requests/financial/overview

Конфигурации запросов данных для таблицы показателей финансового дашборда

- **data.json** – запрос данных показателей (и тултипов)
- **deviationsFormat.json** – запрос отклонений по форматам
- **deviationsRegion.json** – запрос отклонений по регионам
- **graphs.json** – запрос данных для графиков

### Стейт (**src/js/state**)

Утилиты для менеджмента стейта различных аспектов frontend-приложения.

- **comparisonIndicators** – стейт сравнений по показателю (список активных сравнений и пр.)
- **dashboard** – стейт текущего дашборда (даты, режим даты, активные единицы измерения и пр.)
- **export** – стейта экспорта (наборы выбранных срезов и показателей и пр.)
- **filter** – стейт фильтра (выбранные и неактивные опции, и пр.)
- **graphs** – стейт графиков (позиция шкалы, подсветка и пр.)
- **indicators** – стейт показателей текущего дашборда (список активных показателей и пр.)
- **ui** – стейт интерфейса (открытое/закрытое меню, открытый/закрытый тултип, и пр.)

### Утилиты (**src/js/utilities**)

#### config.js

Аккумулятор конфигураций. Собирает разрозненные конфиги в один объект

#### data.js

Запрос данных в Qlik через прокси. Генерирует событие ** datarequest ** с необходимыми параметрами и передает ответ в дашборд

#### date.js

Набор функций-утилит для работы с датами

#### debounce.js

Утилита отсрочки выполнения какого-либо действия (запроса и т.п.)

#### dictionary.js

Поиск перевода в словарях по строке и локали

#### focusTrap.js

Ловушка для фокуса. "Ловит" фокус внутри какого-либо DOM-элемента

#### formatters.js

Набор функций-утилит для форматирования текста

#### graph.js

Набор функций-утилит для работы с элементами графиков

#### indicator.js

Набор функций-утилит для работы с показателями (определение динамики и пр.)

#### internationalization.js

Действие (action) Svelte для интернационализации (перевода) текста в компоненте

#### listFilter.js

Набор функций-утилит для фильтрации различных структур данных использующихся для отрисовки списков (опции выпадающего меню и т.п.)

#### meta.js

Запрос мета-данных в Qlik через прокси. Генерирует событие **`metarequest`** с необходимыми параметрами и передает ответ в компонент

#### render.js

Набор функций-утилит для генерации различных величин (id и т.п.)

#### sectionScroll.js

Действие (action) Svelte для менеджмента скролла секции

#### state.js

Утилита для менеджмента стейта на основе writable из Svelte. Используется для всех утилит менеджмента стейта из **`src/js/state`**

#### tooltip.js

Действие (action) Svelte для отрисовки тултипа на DOM-элементе

#### transitions.js

Директива для вертикальной анимации компонентов (показатели в таблице и списке, и т.п.)

#### values.js

Набор функций-утилит для поиска величин и индексов в различных структурах данных использующихся для отрисовки списков (опции выпадающего меню и т.п.)
